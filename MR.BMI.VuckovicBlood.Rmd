---
title: "MR.BMI.VuckovicBlood"
author: "Chris Thom"
date: "1/29/21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Start Up
```{r message=FALSE}
library(MVMR)
library(TwoSampleMR)
library(MRPRESSO)
library(dplyr)
library(stringr)
library(ggplot2)
library(data.table)

setwd("/Users/thomc/Desktop/Smk.BMI.Blood.MR/MR.BMI.HGB/")


```


### Load data
```{r message=FALSE}

if( file.exists("BMI.filtered.txt") & file.exists("HGB.filtered.txt")) { 
  print("Working from pre-tabulated files")
  e1_comm <- fread("BMI.filtered.txt", header=T)
  out_comm <- fread("HGB.filtered.txt", header=T)
  
} else { 
  print("Loading summ stats and making filtered files")
  e1 <- fread("/Volumes/4TB.RNAseq/GWASdata/Meta-analysis_Locke_et_al+UKBiobank_2018_UPDATED.txt.gz", header=T)
  e1$Phenotype <- "BMI"
  e1$ChrPosRefAlt <- paste0(e1$CHR, ":", e1$POS, "_", e1$Tested_Allele, "_", e1$Other_Allele)
  e1$ChrPosAltRef <- paste0(e1$CHR, ":", e1$POS, "_", e1$Other_Allele, "_", e1$Tested_Allele)

  out <- fread("/Volumes/4TB.RNAseq/GWASdata/BCX2_HGB_EA_GWAMA.out.gz", header=T)
  out$Phenotype <- "HGB"
  
  e1_a <- e1[e1$ChrPosRefAlt %in% out$rs_number,]
  e1_b <- e1[e1$ChrPosAltRef %in% out$rs_number,]
  e1_comm <- bind_rows(e1_a,e1_b)
  
  e1_joina <- left_join(e1_a, out, by = c("ChrPosRefAlt" = "rs_number"))
  e1_joinb <- left_join(e1_b, out, by = c("ChrPosAltRef" = "rs_number"))
  out_comm <- bind_rows(e1_joina, e1_joinb)
  
  write.table(e1_comm, "BMI.filtered.txt", sep="\t", quote= FALSE, row.names = FALSE, col.names = TRUE)
  write.table(out_comm, "HGB.filtered.txt", sep="\t", quote= FALSE, row.names = FALSE, col.names = TRUE)
}

```


### Clump - want this separate in case want to change clumping parameters
```{r message=FALSE}

if( file.exists("BMI.Clumped") & file.exists("HGB.Clumped")) { 
  print("Working from pre-tabulated clump files")
  e1_clump <- fread("BMI.Clumped", header=T)
  out_clump <- fread("HGB.Clumped", header=T)
  
} else { 
  
#clump
e1_sig <- subset(e1_comm, P <= 5E-8)
e1_data <- format_data(e1_sig, type="exposure", snps=e1_sig$SNP, header=T, phenotype_col = "Phenotype", 
  	      snp_col="SNP", beta_col="BETA", se_col="SE", 
				  eaf_col="Freq_Tested_Allele_in_HRS", effect_allele_col="Tested_Allele", other_allele_col="Other_Allele", pval_col="P")
e1_clump <- clump_data(e1_data, clump_kb = 500, clump_r2 = 0.01)
write.table(e1_data, file = "BMI.Clumped", sep="\t", row.names=FALSE, col.names=TRUE, quote=FALSE)

out_clump <- out_comm %>% filter(SNP %in% e1_clump$SNP)
out_clump <- format_data(out_clump, type="outcome", snps=out_clump$SNP, header=T, phenotype_col = "Phenotype.y",
                     snp_col="SNP",
                     beta_col="beta", se_col="se",
                     eaf_col="eaf", effect_allele_col="reference_allele",
                     other_allele_col="other_allele", pval_col="p-value")
write.table(out_clump, file = "HGB.Clumped", sep="\t", row.names=FALSE, col.names=TRUE, quote=FALSE)

}

```


### TwoSample MR
```{r message=FALSE}


#harmonize
dat1 <- harmonise_data(exposure_dat = e1_clump, outcome_dat = out_clump)

#print out instrument stats (for supp table) and R2 for F statistic (based on Shim et al PMID 25898129). 
print("this is R2 for the F-statistic based on Shim et al - plug in to mRnd") 
# sample size for CAD is 547261, SmkInit is 557337 per Dan Hui (paper says up to 1,232,091) --- Using Dan's estimate, Yengo BMI is 700000
dat1$r2 <- 2*(dat1$beta.exposure)^2 * dat1$eaf.exposure * (1-dat1$eaf.exposure) /
  (2*(dat1$beta.exposure)^2 * dat1$eaf.exposure * (1-dat1$eaf.exposure) + 
     (dat1$se.exposure)^2*2*700000*dat1$eaf.exposure * (1-dat1$eaf.exposure))
#or could use generic, with fstat$samplesize.outcome
#dat$r2 <- 2*(dat$beta.outcome)^2 * dat$eaf.outcome * (1-dat$eaf.outcome) / (2*(dat$beta.outcome)^2 * dat$eaf.outcome * (1-dat$eaf.outcome) + (dat$se.outcome)^2*2*dat$samplesize.outcome*dat$eaf.outcome * (1-dat$eaf.outcome))
sum(dat1$r2)

write.table(dat1, "IV.txt", quote=F,col.names=T,row.names=F,sep="\t")


#run MR
res <- mr(dat1)
write.table(res,"MR.txt",quote=F,col.names=T,row.names=F,sep="\t")
het <- mr_heterogeneity(dat1)
write.table(het,"heterogeneity.txt",quote=F,col.names=T,row.names=F,sep="\t")
hp <- mr_pleiotropy_test(dat1)
write.table(hp,"pleiotropy.txt",quote=F,col.names=T,row.names=F,sep="\t")


##Plots
#Scatterplot
pdf("MR.Scatterplot.pdf")
mr_scatter_plot(res, dat1)
dev.off()

#Forest plot
pdf("MR.Forestplot.pdf")
res_single <- mr_singlesnp(dat1)
mr_forest_plot(res_single)
dev.off()

pdf("MR.OtherForestPlot.pdf")
res_single <- mr_singlesnp(dat1, all_method=c("mr_ivw", "mr_two_sample_ml"))
mr_forest_plot(res_single)
dev.off()

#Leave One Out Plot
pdf("MR.LeaveOneOutplot.pdf")
res_loo <- mr_leaveoneout(dat1)
mr_leaveoneout_plot(res_loo)
dev.off()

#Good forest plot with actual estimates
pdf("Good.forestplot.pdf")
res_single <- mr_singlesnp(dat1, all_method = c("mr_ivw", "mr_egger_regression", "mr_weighted_median"))
singlesnp_results <- res_single
exponentiate <- FALSE

requireNamespace("ggplot2", quietly = TRUE)
requireNamespace("plyr", quietly = TRUE)
res <- plyr::dlply(singlesnp_results, c("id.exposure", "id.outcome"), function(d) {
  d <- plyr::mutate(d)
  if (sum(!grepl("All", d$SNP)) < 2) {
    return(blank_plot("Insufficient number of SNPs"))
  }
  levels(d$SNP)[levels(d$SNP) == "All - Inverse variance weighted"] <- "Inverse variance weighted"
  levels(d$SNP)[levels(d$SNP) == "All - MR Egger"] <- "MR Egger"
  levels(d$SNP)[levels(d$SNP) == "All - Weighted median"] <- "Weighted median"
  #d[d$SNP == "All - Inverse variance weighted", "SNP"] <- "Inverse variance weighted"
  #d[d$SNP == "All - MR Egger", "SNP"] <- "MR Egger"
  #d[d$SNP == "All - Weighted median", "SNP"] <- "Inverse variance weighted"
                     am <- grep("All", d$SNP, value = TRUE)

                     d$up <- d$b + 1.96 * d$se
                     d$lo <- d$b - 1.96 * d$se
                     
                     ####### change unit depending on binary/continuous!!!
                     # binary: e.g. smoking initiation
                     #d$b <- exp(d$b * log(2))
                     #d$up <- exp(d$up * log(2))
                     #d$lo <- exp(d$lo * log(2))
                     
                     # continuous: e.g., LfSmk, BMI
                     d$b <- exp(d$b)
                     d$up <- exp(d$up)
                     d$lo <- exp(d$lo)
                     
                     d$tot <- 0.01
                     d$tot[d$SNP %in% am] <- 1
                     d$SNP <- as.character(d$SNP)
                     nom <- d$SNP[!d$SNP %in% am]
                     nom <- nom[order(d$b)]
                     d <- rbind(d, d[nrow(d), ])
                     #d$SNP[nrow(d) - 1] <- ""
                     #d$b[nrow(d) - 1] <- NA
                     #d$up[nrow(d) - 1] <- NA
                     #d$lo[nrow(d) - 1] <- NA
                     d$SNP <- ordered(d$SNP, levels = c(am, "", nom))
                     xint <- 0
                     if (exponentiate) {
                       d$b <- exp(d$b)
                       d$up <- exp(d$up)
                       d$lo <- exp(d$lo)
                       xint <- 1
                     }
                     #print(tail(d, 4))
                     d <- tail(d, 4)
                     d <- head(d, 3)
                     d[d$SNP == "Inverse variance weighted", "samplesize"] <- 3
                     d[d$SNP == "Weighted median", "samplesize"] <- 2
                     d[d$SNP == "MR Egger", "samplesize"] <- 1
                     d$SNP2 <- reorder(d$SNP, d$samplesize)
                     print(d)
                     ggplot2::ggplot(d, aes(y = SNP2, x = b)) + 
                       ggplot2::geom_vline(xintercept = 1, linetype = "dotted") + 
                       ggplot2::geom_errorbarh(ggplot2::aes(xmin = lo, xmax = up, size=as.factor(tot),colour = as.factor(tot)), size=4,
                                height = 0) + ggplot2::geom_point(ggplot2::aes(colour = as.factor(tot)), size=16)  + 
                       ggplot2::scale_colour_manual(values = c("black", "red")) + 
                       ggplot2::scale_size_manual(values = c(0.3, 1)) + 
                       ggplot2::theme(legend.position = "none", 
                        axis.text.y = ggplot2::element_text(size = 14), 
                        axis.ticks.y = ggplot2::element_line(size = 0), 
                        axis.title.x = ggplot2::element_text(size = 14)) + 
                       ggplot2::labs(y = "", x = paste0("MR odds ratio for\n'", 
                                                        d$exposure[1], "' on '", d$outcome[1], "'"))
                   })
p2 <- res

p2[[1]]
dev.off()




```





#Presso

```{r message=FALSE}

presso <- mr_presso(BetaOutcome = "beta.outcome", BetaExposure = "beta.exposure", 
          SdOutcome = "se.outcome", SdExposure = "se.exposure", OUTLIERtest = TRUE, 
          DISTORTIONtest = TRUE, data = dat1, NbDistribution = 10000,  
          SignifThreshold = 0.05)

# remove outliers
dist_outliers <- presso$`MR-PRESSO results`$`Distortion Test`$`Outliers Indices`
dat1_outlier_removed <- dat1[-dist_outliers,]

res <- mr(dat1_outlier_removed, method_list = c("mr_ivw", "mr_egger_regression", "mr_weighted_median" ))
#unused method options: "mr_ivw_mre", "mr_ivw_fe", "mr_egger_regression_bootstrap", "mr_simple_mode", "mr_weighted_mode"

#presso output
write.table(res,"presso.MR.txt",quote=F,col.names=T,row.names=F,sep="\t")
#heterogeneity test
het = mr_heterogeneity(dat_outlier_removed)
write.table(het,"presso.MR.heterogeneity.txt",quote=F,col.names=T,row.names=F,sep="\t")
#horiz pleiotropy test
hp = mr_pleiotropy_test(dat_outlier_removed)
write.table(hp,"presso.MR.pleiotropy.txt",quote=F,col.names=T,row.names=F,sep="\t")


#Plots

#Scatterplot
pdf("presso.MR.Scatterplot.pdf")
mr_scatter_plot(res, dat1_outlier_removed)
dev.off()

#Forest plot
pdf("presso.MR.Forestplot.pdf")
res_single <- mr_singlesnp(dat1_outlier_removed)
mr_forest_plot(res_single)
dev.off()

pdf("presso.MR.OtherForestPlot.pdf")
res_single <- mr_singlesnp(dat1_outlier_removed, all_method=c("mr_ivw", "mr_two_sample_ml"))
mr_forest_plot(res_single)
dev.off()

#Leave One Out Plot
pdf("ivw.presso.MR.LeaveOneOutplot.pdf")
res_loo_ivw <- mr_leaveoneout(dat1_outlier_removed)
mr_leaveoneout_plot(res_loo)
dev.off()

pdf("mr_egger_regression.presso.MR.LeaveOneOutplot.pdf")
res_loo_egger <- mr_leaveoneout(dat1_outlier_removed, method = mr_egger_regression)
mr_leaveoneout_plot(res_loo)
dev.off()

#Good forest plot with actual estimates
pdf("presso.Good.forestplot.pdf")
res_single <- mr_singlesnp(dat1_outlier_removed, all_method = c("mr_ivw", "mr_egger_regression", "mr_weighted_median"))
singlesnp_results <- res_single
exponentiate <- FALSE

requireNamespace("ggplot2", quietly = TRUE)
requireNamespace("plyr", quietly = TRUE)
res <- plyr::dlply(singlesnp_results, c("id.exposure", "id.outcome"), function(d) {
  d <- plyr::mutate(d)
  if (sum(!grepl("All", d$SNP)) < 2) {
    return(blank_plot("Insufficient number of SNPs"))
  }
  levels(d$SNP)[levels(d$SNP) == "All - Inverse variance weighted"] <- "Inverse variance weighted"
  levels(d$SNP)[levels(d$SNP) == "All - MR Egger"] <- "MR Egger"
  levels(d$SNP)[levels(d$SNP) == "All - Weighted median"] <- "Weighted median"
  #d[d$SNP == "All - Inverse variance weighted", "SNP"] <- "Inverse variance weighted"
  #d[d$SNP == "All - MR Egger", "SNP"] <- "MR Egger"
  #d[d$SNP == "All - Weighted median", "SNP"] <- "Inverse variance weighted"
                     am <- grep("All", d$SNP, value = TRUE)

                     d$up <- d$b + 1.96 * d$se
                     d$lo <- d$b - 1.96 * d$se
                     
                     ####### change unit depending on binary/continuous!!!
                     # binary: e.g. smoking initiation
                     #d$b <- exp(d$b * log(2))
                     #d$up <- exp(d$up * log(2))
                     #d$lo <- exp(d$lo * log(2))
                     
                     # continuous: e.g., LfSmk
                     d$b <- exp(d$b)
                     d$up <- exp(d$up)
                     d$lo <- exp(d$lo)
                     
                     d$tot <- 0.01
                     d$tot[d$SNP %in% am] <- 1
                     d$SNP <- as.character(d$SNP)
                     nom <- d$SNP[!d$SNP %in% am]
                     nom <- nom[order(d$b)]
                     d <- rbind(d, d[nrow(d), ])
                     #d$SNP[nrow(d) - 1] <- ""
                     #d$b[nrow(d) - 1] <- NA
                     #d$up[nrow(d) - 1] <- NA
                     #d$lo[nrow(d) - 1] <- NA
                     d$SNP <- ordered(d$SNP, levels = c(am, "", nom))
                     xint <- 0
                     if (exponentiate) {
                       d$b <- exp(d$b)
                       d$up <- exp(d$up)
                       d$lo <- exp(d$lo)
                       xint <- 1
                     }
                     #print(tail(d, 4))
                     d <- tail(d, 4)
                     d <- head(d, 3)
                     d[d$SNP == "Inverse variance weighted", "samplesize"] <- 3
                     d[d$SNP == "Weighted median", "samplesize"] <- 2
                     d[d$SNP == "MR Egger", "samplesize"] <- 1
                     d$SNP2 <- reorder(d$SNP, d$samplesize)
                     print(d)
                     ggplot2::ggplot(d, aes(y = SNP2, x = b)) + 
                       ggplot2::geom_vline(xintercept = 1, linetype = "dotted") + 
                       ggplot2::geom_errorbarh(ggplot2::aes(xmin = lo, xmax = up, size=as.factor(tot),colour = as.factor(tot)), size=4,
                                height = 0) + ggplot2::geom_point(ggplot2::aes(colour = as.factor(tot)), size=16)  + 
                       ggplot2::scale_colour_manual(values = c("black", "red")) + 
                       ggplot2::scale_size_manual(values = c(0.3, 1)) + 
                       ggplot2::theme(legend.position = "none", 
                        axis.text.y = ggplot2::element_text(size = 14), 
                        axis.ticks.y = ggplot2::element_line(size = 0), 
                        axis.title.x = ggplot2::element_text(size = 14)) + 
                       ggplot2::labs(y = "", x = paste0("MR odds ratio for\n'", 
                                                        d$exposure[1], "' on '", d$outcome[1], "'"))
                   })
p2 <- res

p2[[1]]
dev.off()



